function updateDataFromFirebase(snapshot) {
    const data = snapshot.val();
    if (!data) return;

    const now = new Date();
    const timeString = now.getHours() + ':' + now.getMinutes().toString().padStart(2, '0');

    // Obtener datos de Firebase
    const temperature = data.sensor?.temperatura || 0;
    const humidity = data.sensor?.humedad || 0;
    const motorSpeed = data.motor?.rpm || 0;
    const motorState = data.motor?.encendido || false;
    const currentRotation = data.motor?.posicion || 0;  // <-- aquí definimos currentRotation correctamente
    const totalRotationsFromDB = data.motor?.vueltas || 0;

    // Guardar valores anteriores para tendencias
    const prevTemp = tempData.length > 0 ? tempData[tempData.length - 1] : temperature;
    const prevHumidity = humidityData.length > 0 ? humidityData[humidityData.length - 1] : humidity;
    const prevMotor = motorData.length > 0 ? motorData[motorData.length - 1] : motorSpeed;
    const prevRotation = rotationData.length > 0 ? rotationData[rotationData.length - 1] : currentRotation;

    // Actualizar arrays de datos
    timeStamps.push(timeString);
    tempData.push(temperature);
    humidityData.push(humidity);
    motorData.push(motorSpeed);
    rotationData.push(currentRotation);

    if (timeStamps.length > maxDataPoints) {
        timeStamps.shift();
        tempData.shift();
        humidityData.shift();
        motorData.shift();
        rotationData.shift();
    }

    // Actualizar valores mostrados
    document.getElementById('temperature').textContent = temperature.toFixed(1);
    document.getElementById('humidity').textContent = humidity.toFixed(1);
    document.getElementById('motorSpeed').textContent = motorSpeed;
    document.getElementById('motorRotation').textContent = currentRotation;  // valor actual
    document.getElementById('totalRotations').textContent = totalRotationsFromDB; // valor acumulado

    // Actualizar estado del motor
    const motorStateElement = document.getElementById('motorState');
    if (motorState) {
        motorStateElement.textContent = 'Encendido';
        motorStateElement.className = 'status-on';
        document.querySelector('.motor-icon').classList.add('pulse');
        document.querySelector('.rotation-icon').classList.add('pulse');
    } else {
        motorStateElement.textContent = 'Apagado';
        motorStateElement.className = 'status-off';
        document.querySelector('.motor-icon').classList.remove('pulse');
        document.querySelector('.rotation-icon').classList.remove('pulse');
    }

    // Actualizar tendencias
    document.getElementById('temp-trend').innerHTML = getTrendIcon(temperature, prevTemp);
    document.getElementById('humidity-trend').innerHTML = getTrendIcon(humidity, prevHumidity);
    document.getElementById('motor-trend').innerHTML = getTrendIcon(motorSpeed, prevMotor);
    document.getElementById('rotation-trend').innerHTML = getTrendIcon(currentRotation, prevRotation);

    // Aplicar estilos de tendencia
    updateTrendStyle('temp-trend', temperature, prevTemp);
    updateTrendStyle('humidity-trend', humidity, prevHumidity);
    updateTrendStyle('motor-trend', motorSpeed, prevMotor);
    updateTrendStyle('rotation-trend', currentRotation, prevRotation);

    // Actualizar gráficos
    updateChart(tempChart, timeStamps, tempData);
    updateChart(humidityChart, timeStamps, humidityData);
    updateChart(motorChart, timeStamps, motorData);
    updateChart(rotationChart, timeStamps, rotationData);

    // Actualizar última actualización
    lastUpdateTime = new Date();
    document.getElementById('last-update').innerHTML = 
        `<i class="fas fa-clock"></i> Última actualización: ${lastUpdateTime.toLocaleTimeString()}`;

    // Estado de conexión
    updateConnectionStatus(true);
}
