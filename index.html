<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ESP32 - Shaker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- Estilos omitidos por brevedad (puedes copiar los tuyos) --- */
    </style>
</head>
<body>
    <div class="dashboard">
        <header class="header">
            <div class="header-content">
                <h1><i class="fas fa-microchip"></i> Dashboard Shaker ESP32</h1>
                <p>Monitoreo en tiempo real del sistema Shaker</p>
            </div>
            <div class="header-controls">
                <div id="status-badge" class="status-badge disconnected">
                    <span id="status-indicator" class="status-indicator disconnected"></span>
                    <span id="connection-text">Desconectado</span>
                </div>
                <div id="last-update" class="last-update">
                    <i class="fas fa-clock"></i> Última actualización: --
                </div>
            </div>
        </header>

        <!-- Tarjetas de sensores -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-temperature-high"></i> Temperatura</h2>
                <div class="card-icon temp-icon"><i class="fas fa-thermometer-half"></i></div>
            </div>
            <div class="card-value"><span id="temperature">--</span> <span class="card-unit">°C</span></div>
            <div class="trend" id="temp-trend"><i class="fas fa-arrow-right"></i> Esperando datos</div>
            <div class="chart-container"><canvas id="tempChart"></canvas></div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-tint"></i> Humedad</h2>
                <div class="card-icon humidity-icon"><i class="fas fa-water"></i></div>
            </div>
            <div class="card-value"><span id="humidity">--</span> <span class="card-unit">%</span></div>
            <div class="trend" id="humidity-trend"><i class="fas fa-arrow-right"></i> Esperando datos</div>
            <div class="chart-container"><canvas id="humidityChart"></canvas></div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-cog"></i> Estado del Motor</h2>
                <div class="card-icon motor-icon"><i class="fas fa-fan"></i></div>
            </div>
            <div class="card-value"><span id="motorSpeed">--</span> <span class="card-unit">RPM</span></div>
            <div class="motor-status">
                <span>Estado:</span>
                <span id="motorState" class="status-off">Apagado</span>
            </div>
            <div class="trend" id="motor-trend"><i class="fas fa-arrow-right"></i> Esperando datos</div>
            <div class="chart-container"><canvas id="motorChart"></canvas></div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-sync-alt"></i> Vueltas del Motor</h2>
                <div class="card-icon rotation-icon"><i class="fas fa-redo-alt"></i></div>
            </div>
            <div class="card-value"><span id="motorRotation">--</span> <span class="card-unit">vueltas</span></div>
            <div class="rotation-info">
                <span>Total acumulado:</span>
                <span id="totalRotations">0</span>
            </div>
            <div class="trend" id="rotation-trend"><i class="fas fa-arrow-right"></i> Esperando datos</div>
            <div class="chart-container"><canvas id="rotationChart"></canvas></div>
        </div>
    </div>

    <script>
        // Configuración Firebase
        const firebaseConfig = { databaseURL: "https://shaker-3e6f1-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const maxDataPoints = 15;
        let timeStamps = [], tempData = [], humidityData = [], motorData = [], rotationData = [];
        let lastUpdateTime = null;

        // Gráficos
        const tempChart = new Chart(document.getElementById('tempChart').getContext('2d'), {
            type: 'line', data: { labels: timeStamps, datasets: [{ data: tempData, borderColor: '#ff6b6b', backgroundColor: 'rgba(255,107,107,0.1)', fill: true }] }, options: { responsive: true, maintainAspectRatio: false }
        });
        const humidityChart = new Chart(document.getElementById('humidityChart').getContext('2d'), {
            type: 'line', data: { labels: timeStamps, datasets: [{ data: humidityData, borderColor: '#4dabf7', backgroundColor: 'rgba(77,171,247,0.1)', fill: true }] }, options: { responsive: true, maintainAspectRatio: false }
        });
        const motorChart = new Chart(document.getElementById('motorChart').getContext('2d'), {
            type: 'line', data: { labels: timeStamps, datasets: [{ data: motorData, borderColor: '#51cf66', backgroundColor: 'rgba(81,207,102,0.1)', fill: true }] }, options: { responsive: true, maintainAspectRatio: false }
        });
        const rotationChart = new Chart(document.getElementById('rotationChart').getContext('2d'), {
            type: 'line', data: { labels: timeStamps, datasets: [{ data: rotationData, borderColor: '#ff922b', backgroundColor: 'rgba(255,146,43,0.1)', fill: true }] }, options: { responsive: true, maintainAspectRatio: false }
        });

        function getTrendIcon(current, previous) {
            if (current > previous) return '<i class="fas fa-arrow-up"></i> Subiendo';
            if (current < previous) return '<i class="fas fa-arrow-down"></i> Bajando';
            return '<i class="fas fa-arrow-right"></i> Estable';
        }

        function updateTrendStyle(elementId, current, previous) {
            const element = document.getElementById(elementId);
            element.classList.remove('up', 'down');
            if (current > previous) element.classList.add('up');
            if (current < previous) element.classList.add('down');
        }

        function updateChart(chart, labels, data) {
            chart.data.labels = labels;
            chart.data.datasets[0].data = data;
            chart.update('active');
        }

        function updateConnectionStatus(connected) {
            const badge = document.getElementById('status-badge');
            const indicator = document.getElementById('status-indicator');
            const text = document.getElementById('connection-text');
            if (connected) {
                badge.classList.replace('disconnected','connected');
                indicator.classList.replace('disconnected','connected');
                text.textContent = 'Conectado a Firebase';
            } else {
                badge.classList.replace('connected','disconnected');
                indicator.classList.replace('connected','disconnected');
                text.textContent = 'Desconectado';
            }
        }

        function updateDataFromFirebase(snapshot) {
            const data = snapshot.val();
            if (!data) return;
            const now = new Date();
            const timeString = now.getHours() + ':' + now.getMinutes().toString().padStart(2,'0');

            const temperature = data.sensor?.temperatura || 0;
            const humidity = data.sensor?.humedad || 0;
            const motorSpeed = data.motor?.rpm || 0;
            const motorState = data.motor?.encendido || false;
            const currentRotation = data.motor?.posicion || 0;
            const totalRotationsFromDB = data.motor?.vueltas || 0;

            const prevTemp = tempData.length>0?tempData[tempData.length-1]:temperature;
            const prevHumidity = humidityData.length>0?humidityData[humidityData.length-1]:humidity;
            const prevMotor = motorData.length>0?motorData[motorData.length-1]:motorSpeed;
            const prevRotation = rotationData.length>0?rotationData[rotationData.length-1]:currentRotation;

            timeStamps.push(timeString); tempData.push(temperature); humidityData.push(humidity);
            motorData.push(motorSpeed); rotationData.push(currentRotation);

            if(timeStamps.length>maxDataPoints){timeStamps.shift();tempData.shift();humidityData.shift();motorData.shift();rotationData.shift();}

            document.getElementById('temperature').textContent = temperature.toFixed(1);
            document.getElementById('humidity').textContent = humidity.toFixed(1);
            document.getElementById('motorSpeed').textContent = motorSpeed;
            document.getElementById('motorRotation').textContent = currentRotation;
            document.getElementById('totalRotations').textContent = totalRotationsFromDB;

            const motorStateElement = document.getElementById('motorState');
            if(motorState){motorStateElement.textContent='Encendido'; motorStateElement.className='status-on'; document.querySelector('.motor-icon').classList.add('pulse'); document.querySelector('.rotation-icon').classList.add('pulse');}
            else {motorStateElement.textContent='Apagado'; motorStateElement.className='status-off'; document.querySelector('.motor-icon').classList.remove('pulse'); document.querySelector('.rotation-icon').classList.remove('pulse');}

            document.getElementById('temp-trend').innerHTML = getTrendIcon(temperature,prevTemp);
            document.getElementById('humidity-trend').innerHTML = getTrendIcon(humidity,prevHumidity);
            document.getElementById('motor-trend').innerHTML = getTrendIcon(motorSpeed,prevMotor);
            document.getElementById('rotation-trend').innerHTML = getTrendIcon(currentRotation,prevRotation);

            updateTrendStyle('temp-trend',temperature,prevTemp);
            updateTrendStyle('humidity-trend',humidity,prevHumidity);
            updateTrendStyle('motor-trend',motorSpeed,prevMotor);
            updateTrendStyle('rotation-trend',currentRotation,prevRotation);

            updateChart(tempChart,timeStamps,tempData);
            updateChart(humidityChart,timeStamps,humidityData);
            updateChart(motorChart,timeStamps,motorData);
            updateChart(rotationChart,timeStamps,rotationData);

            lastUpdateTime = new Date();
            document.getElementById('last-update').innerHTML = `<i class="fas fa-clock"></i> Última actualización: ${lastUpdateTime.toLocaleTimeString()}`;
            updateConnectionStatus(true);
        }

        function checkDataFreshness() {
            if(!lastUpdateTime) return;
            const diff = new Date()-lastUpdateTime;
            const minutesDiff = Math.floor(diff/60000);
            if(minutesDiff>2){
                updateConnectionStatus(false);
                document.getElementById('last-update').innerHTML = `<i class="fas fa-exclamation-triangle"></i> Datos desactualizados (${minutesDiff} min)`;
            }
        }

        function startFirebaseListener() {
            const dataRef = database.ref('/');
            dataRef.on('value',(snapshot)=>{updateDataFromFirebase(snapshot);}, (error)=>{console.error(error); updateConnectionStatus(false);});
            setInterval(checkDataFreshness,60000);
        }

        document.addEventListener('DOMContentLoaded',()=>{startFirebaseListener(); console.log('Dashboard inicializado correctamente');});
        window.addEventListener('error',(event)=>{console.error('Error global:', event.error); updateConnectionStatus(false);});
    </script>
</body>
</html>
